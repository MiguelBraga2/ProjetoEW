<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório EW</title>
    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }

        #tax{
            float: right;
        }

    </style>
</head>
<body>
    <h1>Relatório EW</h1>
    <h2>Introdução</h2>
        <p>Este relatório tem como objetivo apresentar os resultados obtidos no desenvolvimento do projeto de Engenharia Web
        que tem como tema um Sistema de Gestão de Bases de Dados de Acordãos. O objetivo principal
        deste trabalho passa por conciliar os documentos JSON fornecidos, unificando-os numa única base de dados unificada,
        fornecendo ao utilizador uma interface de consulta e pesquisa de acordãos. Neste relatório, serão apresentadas as 
        decisões tomadas ao longo do desenvolvimento do projeto, bem como as tecnologias utilizadas e as dificuldades encontradas.
        </p> 
    <h2>Análise e Levantamento de Requisitos</h2>
        <p>Numa primeira fase, o grupo realizou a análise do contexto e do âmbito do projeto, adquirindo conhecimento da área através
        de conversas com peritos e utilizadores do sistema. Isto permitiu-nos aprender o vocabulário utilizado e 
        averiguar quais os aspetos que poderiam ser melhorados. Com base nos objetivos/requisitos definidos pelo cliente e com base 
        em novos requisitos identificados pelo grupo, elaboramos a seguinte lista de requisitos funcionais do sistema, subdividida em níveis de utilização:
        </p>
        <h3>ROLE: Consumidor</h3>
        <ul>
            <li>Consultar os acordãos disponíveis na BD, agrupados por tribunal;</li>
            <li>Filtrar e realizar pesquisas nos acordãos disponibilizados quer globalmente quer por tribunal;</li>
            <li>Ordenar os resultados com base em diferentes critérios;</li>
            <li>Adicionar e remover acordãos aos favoritos, adicionando descrições, se pretendido;</li>
            <li>Consultar o histórico recente de consultas;</li>
        </ul>
        <h3>ROLE: Produtor</h3>
        <ul>
            <li>Aceder às funcionalidades do consumidor;</li>
            <li>Adicionar/remover/editar registos por si criados;</li>
        </ul>
        <h3>ROLE: Administrador</h3>
        <ul>
            <li>Aceder às funcionalidades do consumidor;</li>
            <li>Adicionar/remover/editar qualquer registo do sistema;</li>
            <li>Carregar ficheiros JSON de acordãos para a(s) base(s) de dados. </li>
        </ul>
        <p>Abrangendo todos os níveis de acesso, acrescenta-se ainda a necessidade de autenticação para o uso completo
        do sistema. Aqui destacam-se a possibilidade de registo/autenticação com username+password, conta Google ou conta Facebook.
        </p> 
    <h2>Concepção e Desenvolvimento da solução</h2>
        <h3>Tratamento da Base de Dados</h3>
            <p>Um dos primeiros passos dados no desenvolvimento da solução foi o da unificação dos campos de todas as bases de dados.
               Tendo exportado para ficheiro um objeto que relaciona-se cada campo com a contagem de registos que o possuem por meio de uma script 
               Javascript, observamos a existência de mais de 10000 campos diferentes. Assim, foi necessário realizar uma análise cuidada de cada campo,
               verificando se este poderia ser unificado com outro campo ou até mesmo removido. Com a ajuda do portal <a href="http://www.dgsi.pt/home.nsf?OpenDatabase">http://www.dgsi.pt/home.nsf?OpenDatabase</a>,  
               identificamos grande parte dos campos como sendo originários de tabelas existentes em textos. Descartando esses campos, uma vez que não é possível tratá-los, reduzimos a lista de campos para pouco mais de 100.
               A partir daqui, foi necessário analisar o significado de cada campo e verificar se este poderia ser unificado com outro campo. Foi uma tarefa morosa, uma vez que requereu a consulta dos valores de cada campo em cada base de dados. 
               Para além disso, alguns campos foram reduzidos a listas. Por exemplo, Área Temática e Área Temática 1 foram unificados numa lista de áreas temáticas.
               Listam-se então algumas unificações realizadas:
            </p>
            <table>
                <tr>
                    <th>Campos</th>
                    <th>Unificação</th>
                </tr>
                <tr>
                    <td>Recorrido 1/Recorrido 2</td>
                    <td>Recorridos</td>
                </tr>
                <tr>
                    <td>Área Temática/Área Temática 1/Área Temática 2</td>
                    <td>Áreas Temática</td>
                </tr>
                <tr>
                    <td>Referência de Publicação/Referência Publicação 1/Referência Publicação 2</td>
                    <td>Referências de Publicação</td>
                </tr>
                <tr>
                    <td>Normas Julgadas Inconst./Normas Declaradas Inconst.</td>
                    <td>Normas Declaradas Inconst.</td>
                </tr>
                <tr>
                    <td>Secção/Juízo ou Secção</td>
                    <td>Juízo ou Secção</td>
                </tr>
            </table>
            <p>De notar que alguns campos que, à primeira vista, pareciam unificáveis (como 'Data do Acordão' e 'Data da Decisão Singular'), não o
               o foram por apresentarem significado ligeiramente diferente. Um acordão implica um acordo entre pelo menos 2 juízes, enquanto que uma decisão Singular
               é tomada por apenas um magistrado. 
            </p>
            <p>Para além dos campos identificados, foram adicionados outros campos no modelo de um acordão do <i>mongoose</i>. 
               O campo _id é um campo obrigatório, que identifica cada acordão de forma única. Este campo é autoincrementado sempre que inserimos um novo registo na BD.
               Numa retrospetiva do projeto, este campo poderia ter sido substituído um id criado pelo próprio mongoDB, uma vez que este é mais eficiente e não requer controlo por parte do programador.
               Por fim, o campo <i>ProducerId</i> tem como finalidade mapear cada registo ao produtor que eventualmente o criou.     
            </p>
        <h3>Autenticação</h3>
            <p>Paralelamente ao processo de tratamento dos dados, foi elaborado o serviço de autenticação. 
               Este tem como objetivo permitir aos utilizadores autenticarem-se e registarem-se na aplicação com
               diferentes níveis de acesso. A coleção dos utilizadores é formada por documentos com os seguintes campos:
            </p>
            <ul>
               <li>username - Nome do utilizador na aplicação;</li>
               <li>password - Password do utilizador;</li>
               <li>name - Primeiro nome do utilizador;</li>
               <li>surname - Apelido do utilizador;</li>
               <li>email - Email do utilizador;</li>
               <li>level - Nível de acesso (Consumidor, Produtor ou Administrador);</li>
               <li>active - Indica se o utilizador está ativo ou não;</li>
               <li>dateCreated - Data de criação do utilizador;</li>
               <li>dateLastAccess - Data do último acesso;</li>
               <li>providerId</li>
               <li>provider</li>
               <li>history - Lista de ids de processos visitados recentemente;</li>
               <li>favorites - Lista de pares (processo, descrição) que constituem os favoritos.</li>
            </ul>
            <p>Conceptualmente, este serviço é uma API para a coleção <i>users</i> da base de dados. Assim, deverá fornecer
               as seguintes rotas:
            </p>
            <table>
                <tr>
                    <th>Rota</th>
                    <th>Descrição</th>
                </tr>
                <tr>
                    <td>GET /users</td>
                    <td>Devolve todos os utilizadores da BD</td>
                </tr>
                <tr>
                    <td>GET /users/facebook</td>
                    <td>Inicia o processo de autenticação com o facebook</td>
                </tr>
                <tr>
                    <td>GET /users/google/</td>
                    <td>Inicia o processo de autenticação com o google</td>
                </tr>
                <tr>
                    <td>GET /users/:id/history</td>
                    <td>Devolve o histórico do utilizador passado por parâmetro</td>
                </tr>
                <tr>
                    <td>GET /users/:id/favorites</td>
                    <td>Devolve os favoritos do utilizador passado por parâmetro</td>
                </tr>
                <tr>
                    <td>GET /users/:id</td>
                    <td>Devolve um utilizador</td>
                </tr>
                <tr>
                    <td>POST /users</td>
                    <td>Adiciona um utilizador à BD (requer autenticação)</td>
                </tr>
                <tr>
                    <td>POST /users/register</td>
                    <td>Adiciona um utilizador à BD (não requer autenticação) </td>
                </tr>
                <tr>
                    <td>POST /users/login</td>
                    <td>Autentica um utilizador</td>
                </tr>
                <tr>
                    <td>PUT /users/:id</td>
                    <td>Altera um utilizador na BD</td>
                </tr>
                <tr>
                    <td>PUT /users/:id/desativar</td>
                    <td>Desativa a conta de um utilizador</td>
                </tr>
                <tr>
                    <td>PUT /users/:id/ativar</td>
                    <td>Reativa a conta de um utilizador</td>
                </tr>
                <tr>
                    <td>PUT /users/:id/password</td>
                    <td>Altera a password de um utilizador</td>
                </tr>
                <tr>
                    <td>PUT /users/:id/history</td>
                    <td>Adiciona um processo ao histórico do utilizador</td>
                </tr>
                <tr>
                    <td>PUT /users/:id/favorites</td>
                    <td>Adicionar um processo aos favoritos, juntamente com a descrição</td>
                </tr>
                <tr>
                    <td>PUT /users/:id/removeFavorite</td>
                    <td>Remove um processo dos favoritos</td>
                </tr>
                <tr>
                    <td>DELETE /users/:id</td>
                    <td>Remove um utilizador da BD</td>
                </tr>
            </table>
            <p>Tal como acontecerá na API, várias destas rotas deverão estar protegidas.</p>
        <h3>API</h3>
            <p>Genericamente, uma API é uma peça de software que fornece funcionalidade sobre um serviço. Na nossa aplicação, a API REST permite-nos aceder à(s) base(s) de dados,
               fornecendo métodos para a realização de operações CRUD na coleção dos acordãos da BD. A seguir listam-se algumas das rotas disponíveis:
            </p>
            <table>
                <tr>
                    <th>Rota</th>
                    <th>Descrição</th>
                </tr>
                <tr>
                    <td>GET /api/acordaos</td>
                    <td>Devolve todos os acordãos da BD, com base na <i>querystring</i></td>
                </tr>
                <tr>
                    <td>GET /api/acordaos/tribunais</td>
                    <td>Devolve todos os tribunais da BD, juntamente com a designação para a sua sigla</td>
                </tr>
                <tr>
                    <td>GET /api/acordaos/:id</td>
                    <td>Devolve o acordão com o id passado por parâmetro</td>
                </tr>
                <tr>
                    <td>GET /api/acordaos/apensos/:n_processo</td>
                    <td>Devolve os acordãos com o respetivo número de processo</td>
                </tr>
                <tr>
                    <td>GET /api/currentId</td>
                    <td>Devolve o próximo id a ser usado na BD</td>
                </tr>
                <tr>
                    <td>GET /postFile/:file_name</td>
                    <td>Ordena o envio de um ficheiro JSON para a BD</td>
                </tr>
                <tr>
                    <td>POST /api/acordaos</td>
                    <td>Adiciona um novo acordão à BD</td>
                </tr>
                <tr>
                    <td>PUT /api/acordaos/:id</td>
                    <td>Atualiza um acordão na BD</td>
                </tr>
                <tr>
                    <td>DELETE /api/acordaos/:id</td>
                    <td>Elimina um acordão da BD</td>
                </tr>
            </table>
            <p>Relativamente à primeira rota (/api/acordaos) esta pode ser complementada com uma query string
               com os seguintes parâmetros: 
            </p>
            <ul>
                <li>page=`valor` - indica que página de resultados pretendemos obter;</li>
                <li>limit=`valor` - indica o limite de acordãos em cada página;</li>
                <li>livre=`termo` - indica a pesquisa livre pelo termo indicado;</li>
                <li>descritor=`termo` - indica a pesquisa por um termo na taxonomia de descritores;</li>
                <li>campo=`valor` - indica que pretendemos filtrar os acordãos com um determinado valor em certo campo.</li>
            </ul>
            <p>Relativamente à paginação, importa referir que o resultado da rota /api/acordaos devolve um object JSON com os seguintes campos:</p>
            <ul> 
                <li>results - a lista de resultados obtida;</li>
                <li>previous - número e limites da página anterior;</li>
                <li>next - número e limites da página seguinte.</li>
            </ul>
        <h4>Pesquisas</h4>
            <p>Uma primeira abordagem ao problema das pesquisas consistiu na nossa própria implementação da pesquisa em formato
               "Texto Livre" e da pesquisa na taxonomia de descritores. 
            </p>
            <p>A taxonomia de descritores foi implementada como uma árvore de termos, em que
               estes são dispostos de forma hierárquica, de modo que nos ramos superiores da árvore encontram-se termos mais gerais e nos ramos inferiores termos 
               relativos a descritores mais específicos. O critério de separação dos termos foi a existência de contectores sintáticos como proposições (simples ou contraídas)
               ou determinantes. Por exemplo, consideremos o seguinte mapeamento de descritores:
            </p>
            <div>
                <pre stle="display: inline-block">
Abuso - 1
Abuso de liberdade - 3
Abuso de liberdade de expressão - 2,4
Abuso de liberdade de imprensa - 5
Abuso do poder - 3,5
Abuso do poder económico - 2
                </pre>
                <img id="tax" src="ResourcesRelatorio/taxonomia.png" style="display:inline-block; width:300px; margin-top: -150px;" alt="árvore da taxonomia"> <!-- Evitar margens -->
            </div>
            
            <p>Nexte contexto, uma pesquisa nesta árvore pelo descritor "Abuso de liberdade" 
               devolveria os processos 2,3,4 e 5. 
            </p>
            <p>Relativamente à pesquisa livre, pretendíamos ser capazes de mapear, para cada palavra encontrada, os registos onde esta aparecia,
               criando um dicionário de palavras-chave. Apesar de eficaz, esta abordagem tornou-se ineficiente dada a enorme quantidade de registos e, 
               por conseguinte, de palavras. Assim, optamos por utilizar uma ferramenta externa, o Algolia, que nos permite realizar pesquisas em texto livre
               de uma forma bem mais otimizada, recorrendo a uma base de dados externa.
            </p>
        <h4>Integração com o Algolia</h4>
            <p>A base de dados de suporte a esta ferramenta daria suporte às operações de pesquisa e, como tal, deverá estar 100% concordante com a base de dados
               principal, em mongoDB. Assim, para cada operação de alteração de dados na base de dados principal, deverá ser realizada uma operação equivalente
               na base de dados da Algolia. 
            </p>
            <p>Um dos maiores desafios encontrados nesta fase deveu-se às restrições impostas por este serviço quanto ao tamanho dos registos. Pelo facto de, na versão 
               gratuíta, os registos não poderem ultrapassar os 10Kb, foi necessário realizar a divisão dos mesmos em registos mais pequenos. Por consequência, nas operações de
               consulta, será necessário realizar a junção dos registos.  
            </p>
            <p>Este mecanismo foi particularmente relevante aquando do envio de ficheiros JSON para a base de dados. Dada a dimensão de alguns destes ficheiros, a leitura dos mesmos
               para memória de forma integral não foi possível, pelo que recorremos à biblioteca <i>stream-json</i> para ler os registos de acordãos em forma de <i>stream</i>. 
               Para realizar esta operação de forma ainda mais eficiente, outra estratégia usada foi a de envio de registos em <i>batches</i>.
            </p>
        <h3>Interface</h3>
            <p>A interface é o serviço que expõe as páginas que o cliente pode aceder para interagir com o sistema. As páginas devem, por isso, facilitar o cliente nesse processo.
               Para tal, a interface deve ser intuitiva e de fácil utilização. O processo de desenvolvimento deste serviço começou pela elaboração de alguns mockups e pelo mapa de navegação que a seguir se apresenta: 
            </p>
            <img src="ResourcesRelatorio/MaqEstados.png" alt="mapa de navegação">
            <p>A estrutura das páginas e o seu conteúdo foi realizada em <i>pug</i> e estilizada com templates <i>bootstrap</i>. Finalmente, foi adicionada alguma funcionalidade adicional com o uso
               de código Javascript.
            </p>
            <p>Para cada página foi adicionada uma rota específica, tal como podemos ver na tabela seguinte: </p>
            <table>
                <tr>
                    <th>Rota</th>
                    <th>Página</th>
                </tr>
                <tr>
                    <td>GET /</td>
                    <td>Página principal/Tribunais</td>
                </tr>
                <tr>
                    <td>GET /pesquisas</td>
                    <td>Página de pesquisas geral</td>
                </tr>
                <tr>
                    <td>GET /acordaos</td>
                    <td>Página com os acordãos (pode conter querystring)</td>
                </tr>
                <tr>
                    <td>GET /acordaos/:id</td>
                    <td>Página do acordão</td>
                </tr>
                <tr>
                    <td>GET /acordaos/novo</td>
                    <td>Formulário de inserção de um novo acordão</td>
                </tr>
                <tr>
                    <td>GET /acordaosProducer/:id</td>
                    <td>Página com os acordãos de um certo produtor</td>
                </tr>
                <tr>
                    <td>GET /acordaos/edit/:id</td>
                    <td>Página de edição de um acordão</td>
                </tr>
                <tr>
                    <td>GET /users/login</td>
                    <td>Formulário de autenticação</td>
                </tr>
                <tr>
                    <td>GET /users/register</td>
                    <td>Página de registo</td>
                </tr>
                <tr>
                    <td>GET /users/resetPassword</td>
                    <td>Página de reposição de password</td>
                </tr>
                <tr>
                    <td>GET /users/:id</td>
                    <td>Página do Perfil do utilizador</td>
                </tr>
                <tr>
                    <td>GET /users/history/:id</td>
                    <td>Página com o histórico do utilizador</td>
                </tr>
                <tr>
                    <td>GET /users/favourites/:id</td>
                    <td>Página com os favoritos do utilizador</td>
                </tr>
            </table>
            <p>De notar que, para além destas rotas, foram adicionadas rotas para sinalização da execução de operações, como remoção de um acordão: </p>
            <table>
                <tr>
                    <th>Rota</th>
                    <th>Descrição</th>
                </tr>
                <tr>
                    <td>GET /acordaos/delete/:id</td>
                    <td>Remoção de um acordão</td>
                </tr>
                <tr>
                    <td>POST /files</td>
                    <td>Envio de um ficheiro JSON</td>
                </tr>
                <tr>
                    <td>POST /description/:user_id/:acordao_id</td>
                    <td>Consumidor adicionou uma descrição a um acordão</th>
                </tr>
                <tr>
                    <td>POST /acordaos/novo</td>
                    <td>Envio de um novo acordão</td>
                </tr>
                <tr>
                    <td>POST /acordaos/edit</td>
                    <td>Envio da edição de um acordão</td>
                </tr>
            </table>
    <h2>Manual de utilização da aplicação</h2>
        <p>Como forma de facilitar o arranque da aplicação, foi elaborado um ficheiro <i>docker-compose.yml</i> responsável por criar e orquestrar os serviços
        que suportam a aplicação em diferentes <i>docker containers</i>. As portas de funciomento de cada serviço são as seguintes:        
        </p>
        <table>
            <tr>
                <th>Serviço</th>
                <th>Porta</th>
            </tr>
            <tr>
                <td>API<td>
                <td>8001</td>
            </tr>
            <tr>
                <td>Autenticação<td>
                <td>8002</td>
            </tr>
            <tr>
                <td>Interface<td>
                <td>8003</td>
            </tr>
            <tr>
                <td>MongoDB<td>
                <td>27017</td>
            </tr>
        </table>
        <p>Para iniciar a aplicação, basta executar o seguinte comando na pasta raiz do projeto: docker compose build</p>
        <p>Em seguida, abrindo um <i>browser</i> e inserindo o url 'localhost:8003 ter-se-á acesso à página principal da aplicação.</p>
    <h2>Conclusão</h2>
        <p>Em suma, neste projeto pudemos realmente aprender como se constroi uma aplicação <i>web</i> assente em vários microserviços que se articulam entre si para fornecer um serviço único
           para o cliente. Durante o processo de desenvolvimento, deparámo-nos com algumas dificuldades como a necessidade de articulação entre duas bases de dados. Contudo, acreditamos que as dificuldades foram
           ultrapassadas com sucesso, o que contribuiu para que fossem atingidos todos os objetivos estipulados para o projeto. </p>
</body>
</html>